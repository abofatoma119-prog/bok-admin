<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOK - Comprehensive Search</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background: #f4f7f9; direction: rtl; padding: 20px; }
        .card { background: white; max-width: 500px; margin: auto; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .log-screen { background: #222; color: #0f0; font-family: monospace; padding: 10px; border-radius: 8px; font-size: 11px; margin-top: 15px; height: 120px; overflow-y: auto; text-align: left; direction: ltr; }
        input { width: 100%; padding: 15px; margin-top: 10px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; text-align: center; }
        .btn { width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        .btn-search { background: #0056b3; color: white; }
        .btn-update { background: #28a745; color: white; }
        .result-panel { display: none; margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2 style="text-align:center; color:#0056b3;">المستكشف الذكي للقاعدة</h2>
    <p style="font-size:13px; color:#666; text-align:center;">سأبحث في كل المجلدات عن رقم الحساب</p>
    
    <input type="text" id="acc_num" placeholder="أدخل رقم الحساب">
    <button class="btn btn-search" onclick="startDeepSearch()">بدء البحث العميق</button>

    <div id="log" class="log-screen">Ready...</div>

    <div id="res_area" class="result-panel">
        <div style="background:#f9f9f9; padding:15px; border-radius:10px; text-align:center;">
            <p style="margin:0; color:#888;">الرصيد المكتشف:</p>
            <h1 id="view_bal" style="margin:10px 0; color:#28a745;">0.00</h1>
            <p style="font-size:11px; color:blue;">المسار: <span id="view_path"></span></p>
        </div>
        
        <input type="number" id="new_add" placeholder="المبلغ المضاف (+)">
        <button class="btn btn-update" onclick="applyUpdate()">تحديث الآن</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBR1lzuYqNUg1yRRdiNau4o6rjzpX8GjRo",
        authDomain: "ontest-92fe9.firebaseapp.com",
        databaseURL: "https://ontest-92fe9-default-rtdb.firebaseio.com",
        projectId: "ontest-92fe9",
        appId: "1:629491598570:android:fa1376f70fd64dd0c30393"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let foundPath = "";
    let foundBal = 0;

    function log(m) {
        const l = document.getElementById('log');
        l.innerHTML += "> " + m + "<br>";
        l.scrollTop = l.scrollHeight;
    }

    function startDeepSearch() {
        const target = document.getElementById('acc_num').value;
        if(!target) return alert("أدخل رقم الحساب");
        
        document.getElementById('log').innerHTML = "";
        document.getElementById('res_area').style.display = 'none';
        log("Searching for: " + target);

        // جلب القاعدة كاملة لفحصها يدوياً (هذا يضمن إيجاد الرقم أينما كان)
        db.ref().once('value', (snap) => {
            const data = snap.val();
            let found = false;

            if(!data) return log("Error: Database is empty!");

            // البحث في كل المجلدات الرئيسية
            for (let rootKey in data) {
                log("Checking folder: " + rootKey);
                const folder = data[rootKey];

                // إذا كان المجلد نفسه هو رقم الحساب
                if (rootKey === target) {
                    foundPath = rootKey;
                    foundBal = parseFloat(folder.balance) || 0;
                    found = true;
                    break;
                }

                // البحث داخل محتويات المجلد (إذا كان يحتوي على حقل account_number)
                if (typeof folder === 'object') {
                    for (let subKey in folder) {
                        const user = folder[subKey];
                        if (user && (user.account_number == target || user.full_account_number == target)) {
                            foundPath = rootKey + "/" + subKey;
                            foundBal = parseFloat(user.balance) || 0;
                            found = true;
                            break;
                        }
                    }
                }
                if(found) break;
            }

            if(found) {
                log("SUCCESS: Found at " + foundPath);
                document.getElementById('view_path').innerText = foundPath;
                document.getElementById('view_bal').innerText = foundBal.toLocaleString();
                document.getElementById('res_area').style.display = 'block';
            } else {
                log("FAILED: Account not found in any folder.");
                alert("لم يتم العثور على الحساب. تأكد أن رقم الحساب مخزن في حقل اسمه account_number");
            }
        }).catch(e => log("Permission Error: " + e.message));
    }

    function applyUpdate() {
        const val = parseFloat(document.getElementById('new_add').value);
        if(!val) return;
        
        db.ref(foundPath).update({ balance: foundBal + val })
        .then(() => {
            alert("تم التحديث بنجاح!");
            startDeepSearch();
        });
    }
</script>
</body>
</html>
