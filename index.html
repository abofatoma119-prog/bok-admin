<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOK Admin - Diagnostic Tool</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; direction: rtl; }
        .card { background: white; max-width: 500px; margin: auto; padding: 20px; border-radius: 15px; shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-search { background: #003d80; color: white; }
        .btn-update { background: #1e7e34; color: white; margin-top: 10px; }
        .log { background: #333; color: #0f0; padding: 10px; border-radius: 5px; font-size: 12px; margin-top: 10px; height: 100px; overflow-y: auto; text-align: left; direction: ltr; }
        .result { display: none; margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h2>فحص وتحديث الرصيد</h2>
    <input type="text" id="acc_input" placeholder="أدخل رقم الحساب">
    <button class="btn btn-search" onclick="smartSearch()">بدء عملية البحث الشامل</button>

    <div id="log" class="log">بانتظار إدخال رقم الحساب...</div>

    <div id="result_area" class="result">
        <p>تم العثور على المسار: <br><span id="path_found" style="color:blue; font-size:12px;"></span></p>
        <div style="text-align:center;">
            <span style="color:#666;">الرصيد الحالي:</span>
            <h1 id="bal_val" style="color:#1e7e34; margin:5px 0;">0.00</h1>
        </div>
        <input type="number" id="add_amount" placeholder="المبلغ المراد إضافته">
        <button class="btn btn-update" onclick="updateNow()">تحديث الرصيد الآن</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBR1lzuYqNUg1yRRdiNau4o6rjzpX8GjRo",
        authDomain: "ontest-92fe9.firebaseapp.com",
        databaseURL: "https://ontest-92fe9-default-rtdb.firebaseio.com",
        projectId: "ontest-92fe9",
        appId: "1:629491598570:android:fa1376f70fd64dd0c30393"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let finalPath = "";
    let currentBalance = 0;

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML += "> " + msg + "<br>";
        log.scrollTop = log.scrollHeight;
    }

    async function smartSearch() {
        const acc = document.getElementById('acc_input').value;
        if(!acc) return alert("أدخل الرقم");
        
        document.getElementById('log').innerHTML = ""; // مسح السجل
        addLog("بدء البحث عن الحساب: " + acc);

        // المحاولة 1: البحث في جدول user_session
        addLog("محاولة البحث في مجلد 'user_session'...");
        db.ref('user_session').orderByChild('account_number').equalTo(acc).once('value', (s) => {
            if(s.exists()) {
                proceed(s, 'user_session');
            } else {
                addLog("فشل البحث في 'user_session'.");
                
                // المحاولة 2: البحث في الجذر الرئيسي مباشرة
                addLog("محاولة البحث في الجذر الرئيسي (Root)...");
                db.ref().orderByChild('account_number').equalTo(acc).once('value', (s2) => {
                    if(s2.exists()) {
                        proceed(s2, 'Root');
                    } else {
                        // المحاولة 3: البحث عن المجلد الذي اسمه هو رقم الحساب
                        addLog("محاولة البحث عن مجلد باسم رقم الحساب نفسه...");
                        db.ref(acc).once('value', (s3) => {
                            if(s3.exists()) {
                                directProceed(s3, acc);
                            } else {
                                addLog("للأسف، لم يتم العثور على الرقم في أي مكان.");
                                alert("لم نجد بيانات لهذا الرقم. تأكد من وجوده في Firebase بنفس المسمى.");
                            }
                        });
                    }
                });
            }
        });
    }

    function proceed(snapshot, tableName) {
        snapshot.forEach(child => {
            finalPath = (tableName === 'Root' ? '' : tableName + '/') + child.key;
            currentBalance = parseFloat(child.val().balance) || 0;
            display();
            addLog("نجاح! تم العثور على البيانات في " + tableName);
        });
    }

    function directProceed(snapshot, path) {
        finalPath = path;
        currentBalance = parseFloat(snapshot.val().balance) || 0;
        display();
        addLog("نجاح! تم العثور على المسار المباشر.");
    }

    function display() {
        document.getElementById('path_found').innerText = finalPath;
        document.getElementById('bal_val').innerText = currentBalance.toLocaleString();
        document.getElementById('result_area').style.display = 'block';
    }

    function updateNow() {
        const amount = parseFloat(document.getElementById('add_amount').value);
        if(!amount) return;

        db.ref(finalPath).update({ balance: currentBalance + amount })
        .then(() => {
            alert("تم التحديث!");
            smartSearch();
        });
    }
</script>
</body>
</html>
